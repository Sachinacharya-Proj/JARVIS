# IMPORTING ALL THE ESSENTIAL MODULES HERE
import pyttsx3 #pip install pyttsx3
import speech_recognition as sr #pip install speechRecognition
import datetime # Defultly Available
import wikipedia #pip install wikipedia
import webbrowser # Default
import os # Default
import smtplib # Default
from modules.chatterRob import ChatWithMeNow # Custom Module
import datefinder # pip install datefinder
import winsound # pip install winsound or Default
import modules.weatherForcaster as weatherForcaster # Custom Module
import random
import schedule
import modules.qrcodeGenerator as qrcodeGenerator
import modules.qrcodeScanner as qrcodeScanner
import time
import pywhatkit

try:
    os.system("cls")
except Exception as e:
    os.system("clear")

morning_greetings_array = ['Good morning, Sachin sir!', 'Hello sir, Very good morning', "Good Morming, Sachin Sir, how are you doin'"]
afternoom_greetings_array = ['Afternoon, Sachin Sir!', "What's Up Sir, Good afternoon", "Nice to see you, again Sir"]
evening_greetings_array = ['Good evening, Sachin, sir!', "Hope you were having a good time, evening sachin sir"]
regular_greetings = ["You seems happy sir, today!", "You looks great as always", "I am so happy to here from you sir", "As always, I am at you service sir"]

engine = pyttsx3.init('sapi5')
voices = engine.getProperty('voices')
# print(voices[1].id)
engine.setProperty('voice', voices[0].id)

def SetAlarmPlease(name, timeString):
    alarmDate = datefinder.find_dates(timeString)
    for match in alarmDate:
        print(match)
    match_string = str(match)
    alarm_time = match_string[11:]
    alarm_hour = int(alarm_time[:-6])
    alarm_minutes = int(alarm_time[3:-3])
    alarm_seconds = int(alarm_time[6:])
    print(alarm_hour,alarm_minutes, alarm_seconds)

    while True:
        if alarm_hour == datetime.datetime.now().hour:
            if alarm_minutes == datetime.datetime.now().minute:
                print(f"Alarm Title: {name}")
                winsound.PlaySound('C:\\Users\\Dell\\Desktop\\Alarm\\alarm.m4a', winsound.SND_LOOP)
            elif alarm_minutes < int(datetime.datetime.now().minute):
                break

def speak(audio):
    engine.say(audio)
    engine.runAndWait()

def wishMe():
    hour = int(datetime.datetime.now().hour)
    # print(random.randint(0, len(morning_greetings_array) - 1))
    # print(morning_greetings_array[0])
    if hour>=0 and hour<12:
        greets = morning_greetings_array[random.randint(0, len(morning_greetings_array) - 1)]
        print(greets)
        speak(str(greets))

    elif hour>=12 and hour<18:
        greets = afternoom_greetings_array[random.randint(0, len(afternoom_greetings_array) - 1)]
        print(greets)
        speak(str(greets))

    else:
        greets = evening_greetings_array[random.randint(0, len(evening_greetings_array) - 1)]
        print(greets)
        speak(str(greets))

    greets = regular_greetings[random.randint(0, len(regular_greetings) - 1)]
    print(greets)
    speak(str(greets))

def takeCommand():
    #It takes microphone input from the user and returns string output

    r = sr.Recognizer()
    with sr.Microphone() as source:
        print("Listening...")
        r.energy_threshold = 1000
        r.pause_threshold = 1
        audio = r.listen(source)

    try:
        print("Recognizing...")
        query = r.recognize_google(audio, language='en-in')
        print(f"User said: {query.lower()}\n")

    except Exception:
        # print(e)
        print("Say that again please...sir?")
        return "None"
    return query.lower()

def sendEmail(to, content):
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.ehlo()
    server.starttls()
    my_email_address = "acharyaraj9865032909@gmail.com" #USE YOUR EMAIL ADDRESS IF YOU ARE NOT SACHIN ACHARYA
    my_email_password = os.environ.get("DB_PASSWORD") or "INPUT YOUR PASSWORD HERE OR CHANGE WHOLE LINE WITH PASSWD"
    server.login(my_email_address, my_email_password)
    server.sendmail(my_email_address, to, content)
    server.close()

if __name__ == "__main__":
    wishMe()
    while True:
    # if 1:
        query = takeCommand().lower()

        # Logic for executing tasks based on query
        if 'wikipedia' in query:
            try:
                speak(f'Searching {query}...')
                query = query.replace("wikipedia", "")
                results = wikipedia.summary(query)
                speak("According to Wikipedia")
                print(results)
                speak(results)
            except Exception:
                print("Error Occured! Sorry for Inconvinience")
                speak("Sorry, sir! Something unexcepted happened")
        elif "generate qr code" in query or "create qr code" in query or "generate bar code" in query or "create bar code" in query or "create barcode" in query or "generate barcode" in query:
            speak("You wanna Generate BAR CODE or QR CODE?")
            taken = takeCommand()
            if "qrcode" in taken or "qr code" in query:
                print("String you wanna wrap within in?")
                speak("String you wanna wrap within in?")
                string = takeCommand()
                speak("Name for Output file?")
                nameFile = takeCommand()
                print(f"It will be coded to QR CODE: {string}")
                speak(f"String {string} will be converted to QR CODE, please check Folder Codes")
                result = qrcodeGenerator.CreateQRCode(string, nameFile)
                if result ==True:
                    speak("QR CODE IS SUCCESSFULLY GENERATED")
            elif "barcode" in query or "bar code" in query:
                speak("IT WILL GENERATE BARCODE ONLY FOR ALPHANUMERIC STRINGS")
                speak("String you wanna wrap within in?")
                string = takeCommand()
                speak("Name of Output file")
                nameFile = takeCommand()
                print(f"It will be coded to BAR CODE: {string}")
                speak(f"String {string} will be converted to BAR CODE, please check Folder Codes")
                result = qrcodeGenerator.BarcodeCreator(string, nameFile)
                if result ==True:
                    speak("BAR CODE IS SUCCESSFULLY GENERATED")

        elif "morning" in query or "evening" in query or "afternoon" in query or"night" in query:
            resultGot = ChatWithMeNow(query)
            if resultGot != None:
                speak(resultGot)
                print(resultGot)
        elif query == "view all command":
            queryString = "the command lines are\n1. Wikipedia follow by Subject to fetch data from wikipedia regarding Subject\n2. Opne YoutTube: Open youtube in browser\n3. Stream followed by content to view in Youtube\n4. Search followed by keyword to google it\n5. "
            print(queryString)

        elif 'open youtube' in query:
            webbrowser.open("https://www.youtube.com/")
            webbrowser.WindowsDefault()
        elif 'stream' in query:
            query = query.replace("stream", "")
            speak(f'Searching YouTube for {query}')
            print(f'Searching YouTube for {query}\n')
            webbrowser.open(f"https://www.youtube.com/results?search_query={query}")
        elif 'play' in query and 'on youtube' in query:
            query = query.replace('play', '')
            query = query.replace('on youtube', '')
            speak(f'Playing {query} on YouTube')
            print(f'Playing {query} on YouTube')
            pywhatkit.playonyt(query)
        elif 'search' in query:
            query = query.replace("search", "")
            speak(f'Googling {query}')
            print(f'Googling {query}\n')
            webbrowser.open(f"https://www.google.com/search?q={query}")

        elif 'open stackoverflow' in query or "open stack overflow" in query:
            try:
                speak("Oping Stackoverflow")
                webbrowser.open("https://stackoverflow.com/")
                webbrowser.WindowsDefault()
            except Exception as e:
                print(f"Error Occured!", format(e))
                
        elif query == 'play music' or query == "play musics":
            music_dir = 'C:\\Users\\Dell\\Music'
            songs = os.listdir(music_dir)
            selected_audio = songs[random.randint(0, len(songs) - 1)]
            if ".mp3" in selected_audio:
                pass
            else:
                selected_audio = songs[random.randint(0, len(songs) - 1)]
            print(selected_audio)
            speak(f"Playing {selected_audio}")
            os.startfile(os.path.join(music_dir, selected_audio))
        elif 'open code' in query:
            codePath = "C:\\Users\\Dell\\AppData\\Local\\Programs\\Microsoft VS Code\\Code.exe"
            os.startfile(codePath)

        elif 'open pycharm' in query:
            codePath = "C:\\Program Files\\JetBrains\\PyCharm Community Edition 2020.1.4\\bin\\pycharm64.exe"
            os.startfile(codePath)
        elif query == "shutdown the computer" or query == "initiat shutdown command" or query == "shutdown my device" or query == "run shutdown command":
            speak("You've executed Shutdown Command, are you sure, Sir?")
            ask = takeCommand()
            if "yes" in ask or "yep" in ask or "yeah" in ask or "yea" in ask or "sure" in ask or "positive" in ask or "damn yeah" in ask or "hell yeah" in query:
                time.sleep(4)
                os.system("shutdown /p")
        elif "set alarm" in query:
            print("Setting Alarm will pause Services of JARVIS as you wanna take rest")
            speak("Setting Alarm will pause Services of JARVIS as you wanna take rest")
            speak("For what is this alarm?")
            reason = takeCommand()
            speak("For what time should I set Alarm for you, sir?")
            time = takeCommand()
            SetAlarmPlease(reason, time)
        elif "scan code" in query:
            speak("You will need to end all session if you enter this command")
            permission = takeCommand()
            if "okay" in permission or "ok" in permission or "alright" in permission:
                qrcodeScanner.MainFunc()

        elif 'wrap up all' in query or 'close all' in query:
            hour = int(datetime.datetime.now().hour)
            speak("Closing all session including current one")
            if hour > 22:
                speak("Good night sir")
            os.system("cls")
            exit()
        elif "let us chat" in query or "let's chat" in query:
            speak("Alright sir, let's chat, I am listening sir!")
            while True:
                print('You are chatting with me')
                print("________________________")
                takingCommand = takeCommand()
                if takingCommand == "exit chatting":
                    print("Nice talks sir!")
                    speak("Nice talks sir!")
                    print("No more Chatting is going on")
                    print("_______________________")
                    break
                else:
                    resultGot = ChatWithMeNow(takingCommand)
                    if resultGot != None:
                        speak(resultGot)
                        print(resultGot)
            # print(ChatWithMeNow(str(query)))
        elif query == "clear screen":
            speak("Clearing Screen")
            os.system("cls")
        elif 'send email' in query or "send mail" in query:
            try:
                speak("Whome to?")
                to = takeCommand()
                takeAddress = input("Receiver Address: ")
                speak("What should I say?")
                content = takeCommand()
                if takeAddress == "":
                    receiver = to
                else:
                    receiver = takeAddress
                speak("All okay sir, may I send Now?")
                ask = takeCommand()
                if ask == "send it" or ask == "send":

                    sendEmail(receiver, content)
                    speak(f"Email has been sent to {receiver}!")
            except Exception as e:
                print(e)
                speak("Sorry, sir some technical error has been occured")
        elif "what" in query or "find me" in query or "what time is it" in query or "what is" in query or "tell me" in query or "what about" in query:
            try:
                outGain = weatherForcaster.AskForDetails(query)
                print(outGain)
                speak(outGain)
            except Exception:
                print("Returned None")
                speak("Sorry sir, Cannot found the required results!")
                speak("You may need to Update me! Just asking")
        elif query:
            try:
                outGain = weatherForcaster.AskForDetails(query)
                if outGain == e:
                    print("Error")
                else:
                    print(outGain)
                    speak(outGain)
            except Exception:
                print("Returned None")